{% extends "base.html" %}

{% block title %}Produtos em Destaque e Ofertas | {{ config.get('titulo_site', 'Loja') }}{% endblock %}

{% block content %}

    <div class="banner-top" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('{{ config.get('banner_img') }}');
        height: 220px;
        background-size: cover;
        background-position: center;
        margin-bottom: 25px;
        display: flex; align-items: center; justify-content: center; color: white; text-align: center; border-radius: 0 0 15px 15px;">
        
        {# Removida a linha que causava o erro "None" e mantido apenas o título se existir #}
        {% if config.get('titulo_site') and config.get('titulo_site') != 'None' %}
            <h1 style="font-size: 2em; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); font-weight: bold;">
                {{ config.get('titulo_site') }}
            </h1>
        {% endif %}
    </div>

    {% if ofertas %}
    <section class="container">
        <h2 style="color: #d10024; font-size: 1.3em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold;">
            <i class="fa fa-bolt"></i> OFERTAS RELÂMPAGO
        </h2>

        <div class="product-grid">
            {% for produto in ofertas %}
            <div class="product-card" style="border: 1px solid #ffdbdb; position: relative;">

                {% set desconto = 100 - (produto['novo_preco'] / produto['preco'] * 100) if produto['preco'] and produto['novo_preco'] else 0 %}
                <span style="position: absolute; top: 10px; left: 10px; background: #d10024; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; z-index: 10;">
                    {{ "%.0f"|format(desconto) }}% OFF
                </span>

                <a href="{{ url_for('produto_detalhes', id_produto=produto.id) }}" style="text-decoration: none; color: inherit;">
                    <div class="img-container">
                        {% if produto.img_path_1 %}
                            <img src="{{ url_for('static', filename='uploads/' + produto.img_path_1.split('/')[-1]) }}" alt="{{ produto.nome }}">
                        {% else %}
                            <img src="{{ url_for('static', filename='placeholder.png') }}" alt="Sem imagem">
                        {% endif %}
                    </div>

                    <div class="info-container">
                        <h3 class="product-name" style="font-size: 14px; height: 40px; overflow: hidden;">{{ produto.nome }}</h3>

                        <div style="margin-top: 8px;">
                            <span style="text-decoration: line-through; color: #999; font-size: 12px;">
                                R$ {{ "%.2f"|format(produto.preco)|replace('.', ',') }}
                            </span>
                            <div class="price-tag" style="color: #d10024; font-size: 20px; font-weight: bold;">
                                R$ {{ "%.2f"|format(produto.novo_preco)|replace('.', ',') }}
                            </div>
                        </div>

                        {% if produto.oferta_fim %}
                            <div class="countdown-timer" data-time="{{ produto['oferta_fim'] }}"
                                style="font-size: 11px; color: #d10024; font-weight: bold; margin-top: 8px; background: #fff0f0; padding: 4px; border-radius: 4px; text-align: center;">
                                <i class="fa fa-clock"></i> Aguarde...
                            </div>
                        {% endif %}
                    </div>
                </a>

                <div style="padding: 0 12px 12px;">
                    <a href="{{ url_for('comprar_produto', id_produto=produto.id) }}" class="btn-compra" style="background: #d10024; width: 100%; display: block; text-align: center; padding: 10px; color: white; border-radius: 5px; text-decoration: none; font-weight: bold;">
                        Comprar Agora
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="container" style="margin-top: 40px;">
        <h2 style="font-size: 1.3em; color: #333; margin-bottom: 20px; font-weight: bold;">PRODUTOS EM DESTAQUE</h2>

        <div class="product-grid">
            {% set non_offer_products = produtos | rejectattr('em_oferta') | list %}
            {% for produto in non_offer_products %}
            <div class="product-card">
                <a href="{{ url_for('produto_detalhes', id_produto=produto.id) }}" style="text-decoration: none; color: inherit;">
                    <div class="img-container">
                        {% if produto.img_path_1 %}
                            <img src="{{ url_for('static', filename='uploads/' + produto.img_path_1.split('/')[-1]) }}" alt="{{ produto.nome }}">
                        {% else %}
                            <img src="{{ url_for('static', filename='placeholder.png') }}" alt="Sem imagem">
                        {% endif %}
                    </div>
                    <div class="info-container">
                        <h3 class="product-name" style="font-size: 14px; height: 40px; overflow: hidden;">{{ produto.nome }}</h3>
                        <div class="price-tag" style="font-size: 18px; font-weight: bold; color: #333;">
                            R$ {{ "%.2f"|format(produto.preco)|replace('.', ',') }}
                        </div>
                    </div>
                </a>
                <div style="padding: 0 12px 12px;">
                    <a href="{{ url_for('comprar_produto', id_produto=produto.id) }}" class="btn-compra" style="width: 100%; display: block; text-align: center; padding: 10px; border-radius: 5px; text-decoration: none; font-weight: bold;">
                        Comprar
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <script>
        // Script de Contagem Regressiva Otimizado
        function startCountdowns() {
            const timers = document.querySelectorAll('.countdown-timer');
            
            timers.forEach(timer => {
                const targetDate = new Date(timer.dataset.time).getTime();
                
                const update = setInterval(() => {
                    const now = new Date().getTime();
                    const diff = targetDate - now;

                    if (diff <= 0) {
                        clearInterval(update);
                        timer.innerHTML = "OFERTA ENCERRADA";
                        return;
                    }

                    const h = Math.floor(diff / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);

                    timer.innerHTML = `<i class="fa fa-clock"></i> Acaba em: ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }, 1000);
            });
        }
        document.addEventListener('DOMContentLoaded', startCountdowns);
    </script>
{% endblock %}
